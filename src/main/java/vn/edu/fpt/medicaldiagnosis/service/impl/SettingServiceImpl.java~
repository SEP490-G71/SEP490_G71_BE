package vn.edu.fpt.medicaldiagnosis.service.impl;

import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import lombok.experimental.FieldDefaults;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import vn.edu.fpt.medicaldiagnosis.dto.request.SettingRequest;
import vn.edu.fpt.medicaldiagnosis.dto.response.SettingResponse;
import vn.edu.fpt.medicaldiagnosis.entity.Setting;
import vn.edu.fpt.medicaldiagnosis.exception.AppException;
import vn.edu.fpt.medicaldiagnosis.exception.ErrorCode;
import vn.edu.fpt.medicaldiagnosis.mapper.SettingMapper;
import vn.edu.fpt.medicaldiagnosis.repository.SettingRepository;
import vn.edu.fpt.medicaldiagnosis.service.SettingService;

import static lombok.AccessLevel.PRIVATE;

@Service
@Slf4j
@RequiredArgsConstructor
@FieldDefaults(level = PRIVATE, makeFinal = true)
public class SettingServiceImpl implements SettingService {
    SettingRepository settingRepository;
    SettingMapper settingMapper;
    @Override
    public SettingResponse getSetting() {
        Setting setting = (Setting) settingRepository.findFirstByOrderByCreatedAtAsc()
                .orElseThrow(() -> new AppException(ErrorCode.SETTING_NOT_FOUND));
        return mapToResponse(setting);
    }

    @Override
    public SettingResponse upsertSetting(SettingRequest request) {
        Setting setting = (Setting) settingRepository.findFirstByOrderByCreatedAtAsc()
                .orElse(Setting.builder().build()); // nếu chưa có thì tạo mới

        setting.setHospitalName(request.getHospitalName());
        setting.setHospitalPhone(request.getHospitalPhone());
        setting.setHospitalAddress(request.getHospitalAddress());
        setting.setHospitalEmail(request.getHospitalEmail());
        setting.setBankAccountNumber(request.getBankAccountNumber());
        setting.setBankCode(request.getBankCode());
        setting.setLatestCheckInMinutes(request.getLatestCheckInMinutes());
        setting.setPaginationSizeList(request.getPaginationSizeList());
        setting.setQueueOpenTime(request.getQueueOpenTime());
        setting.setQueueCloseTime(request.getQueueCloseTime());
        setting.setMinBookingDaysBefore(request.getMinBookingDaysBefore());
        settingRepository.save(setting);
        return mapToResponse(setting);
    }

    private SettingResponse mapToResponse(Setting setting) {
        return SettingResponse.builder()
                .hospitalName(setting.getHospitalName())
                .hospitalPhone(setting.getHospitalPhone())
                .hospitalAddress(setting.getHospitalAddress())
                .hospitalEmail(setting.getHospitalEmail())
                .bankAccountNumber(setting.getBankAccountNumber())
                .bankCode(setting.getBankCode())
                .latestCheckInMinutes(setting.getLatestCheckInMinutes())
                .queueOpenTime(setting.getQueueOpenTime())
                .queueCloseTime(setting.getQueueCloseTime())
                .minBookingDaysBefore(setting.getMinBookingDaysBefore())
                .paginationSizeList(setting.getPaginationSizeList())
                .build();
    }
}
